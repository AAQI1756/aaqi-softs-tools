<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR & Barcode Scanner</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
body{margin:0;font-family:'Montserrat',sans-serif;background:#f5f5f5;display:flex;flex-direction:column;align-items:center;padding:20px;}
h2{text-align:center;margin-bottom:15px;}
#scannerContainer{position:relative;width:100%;max-width:600px; border-radius:15px; overflow:hidden;}
video{width:100%;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.1); transition: border 0.3s;}
.flash{border:5px solid #06b6d4 !important;}
#controls{display:flex;justify-content:center;gap:10px;margin-top:10px;flex-wrap:wrap;}
button,input[type=file]{padding:10px 15px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;transition:0.3s;}
button{background:#06b6d4;color:#fff;}
button:hover{background:#0ea5e9;}
input[type=file]{background:#ddd;}
#popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;backdrop-filter:blur(5px);background: rgba(0,0,0,0.3);justify-content:center;align-items:center;z-index:1000;animation:fadeIn 0.3s;}
#popupContent{background:#fff;padding:25px;border-radius:20px;max-width:90%;width:400px;max-height:80%;overflow-y:auto;animation:bounceIn 0.4s;}
.resultLine{margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.resultLine button{margin-left:10px;padding:5px 10px;font-size:14px;}
@keyframes bounceIn {
  0% {transform: scale(0.5); opacity:0;}
  60% {transform: scale(1.1); opacity:1;}
  80% {transform: scale(0.95);}
  100% {transform: scale(1);}
}
@keyframes fadeIn {from {opacity:0;} to {opacity:1;}}
@media(max-width:600px){button,input[type=file]{padding:8px 10px;font-size:14px;}}
</style>
</head>
<body>
<h2>QR & Barcode Scanner</h2>
<div id="scannerContainer">
  <video id="video" autoplay></video>
</div>
<div id="controls">
  <button id="lightBtn">Light On/Off</button>
  <input type="file" id="uploadImage" accept="image/*">
</div>

<div id="popup">
  <div id="popupContent">
    <h3>Scan Result</h3>
    <div id="resultContent"></div>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.mp3" preload="auto"></audio>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let selectedDeviceId;
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('video');
const popup = document.getElementById('popup');
const resultContent = document.getElementById('resultContent');
const beep = document.getElementById('beep');
let stream;
let torchOn = false;

// Auto-start camera
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
.then(s => {
    stream = s;
    videoElement.srcObject = stream;
    const track = stream.getVideoTracks()[0];
    selectedDeviceId = track.getSettings().deviceId;
    scanVideo();
})
.catch(err => alert('Camera access denied or not available: '+err));

// Scan video continuously
function scanVideo(){
  codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err)=>{
    if(result){
      flashVideo();
      feedback();
      showResultPopup(result.getText());
      codeReader.reset();
    }
  });
}

// Flash animation
function flashVideo(){
  videoElement.classList.add('flash');
  setTimeout(()=> videoElement.classList.remove('flash'), 300);
}

// Beep & vibration feedback
function feedback(){
  beep.currentTime=0; beep.play();
  if(navigator.vibrate) navigator.vibrate(200);
}

// Light toggle
document.getElementById('lightBtn').addEventListener('click', ()=>{
  if(!stream) return;
  const track = stream.getVideoTracks()[0];
  const capabilities = track.getCapabilities();
  if(!capabilities.torch){ alert('Torch not supported on this device'); return;}
  torchOn = !torchOn;
  track.applyConstraints({advanced:[{torch: torchOn}]});
});

// Upload image
document.getElementById('uploadImage').addEventListener('change', async(e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = async ()=>{
    try{
      const result = await codeReader.decodeFromImage(img);
      flashVideo();
      feedback();
      showResultPopup(result.getText());
    }catch(err){ alert('No QR/Barcode detected in the image'); }
  }
});

// Show popup
function showResultPopup(text){
  popup.style.display='flex';
  resultContent.innerHTML='';
  const lines = text.split(/\r?\n/);
  lines.forEach(line=>{
    if(!line.trim()) return;
    const div = document.createElement('div');
    div.className='resultLine';
    const span = document.createElement('span');
    span.textContent = line;
    const btn = document.createElement('button');
    if(line.startsWith('http')||line.startsWith('www')){
      btn.textContent='Visit';
      btn.onclick=()=> window.open(line,'_blank');
    } else {
      btn.textContent='Copy';
      btn.onclick=()=> navigator.clipboard.writeText(line);
    }
    div.appendChild(span);
    div.appendChild(btn);
    resultContent.appendChild(div);
  });
}

// Close popup
function closePopup(){ popup.style.display='none'; }
</script>
</body>
</html>
